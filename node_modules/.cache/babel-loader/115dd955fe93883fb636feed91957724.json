{"ast":null,"code":"import _regeneratorRuntime from\"/Users/diegoponciano/Desktop/ryan/liquity/frontend/packages/dev-frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/diegoponciano/Desktop/ryan/liquity/frontend/packages/dev-frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/Users/diegoponciano/Desktop/ryan/liquity/frontend/packages/dev-frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import _objectSpread from\"/Users/diegoponciano/Desktop/ryan/liquity/frontend/packages/dev-frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import React,{useState,useContext,useEffect,useCallback}from\"react\";import{Flex,Text,Box}from\"theme-ui\";import{hexDataSlice,hexDataLength}from\"@ethersproject/bytes\";import{defaultAbiCoder}from\"@ethersproject/abi\";import{buildStyles,CircularProgressbarWithChildren}from\"react-circular-progressbar\";import\"react-circular-progressbar/dist/styles.css\";import{useLiquity}from\"../hooks/LiquityContext\";import{Icon}from\"./Icon\";import{Tooltip}from\"./Tooltip\";import{jsx as _jsx}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";var strokeWidth=10;var circularProgressbarStyle={strokeLinecap:\"butt\",pathColor:\"white\",trailColor:\"rgba(255, 255, 255, 0.33)\"};var slowProgress={strokeWidth:strokeWidth,styles:buildStyles(_objectSpread(_objectSpread({},circularProgressbarStyle),{},{pathTransitionDuration:30}))};var fastProgress={strokeWidth:strokeWidth,styles:buildStyles(_objectSpread(_objectSpread({},circularProgressbarStyle),{},{pathTransitionDuration:0.75}))};var TransactionContext=/*#__PURE__*/React.createContext(undefined);export var TransactionProvider=function TransactionProvider(_ref){var children=_ref.children;var transactionState=useState({type:\"idle\"});return/*#__PURE__*/_jsx(TransactionContext.Provider,{value:transactionState,children:children});};var useTransactionState=function useTransactionState(){var transactionState=useContext(TransactionContext);if(!transactionState){throw new Error(\"You must provide a TransactionContext via TransactionProvider\");}return transactionState;};export var useMyTransactionState=function useMyTransactionState(myId){var _useTransactionState=useTransactionState(),_useTransactionState2=_slicedToArray(_useTransactionState,1),transactionState=_useTransactionState2[0];return transactionState.type!==\"idle\"&&(typeof myId===\"string\"?transactionState.id===myId:transactionState.id.match(myId))?transactionState:{type:\"idle\"};};var hasMessage=function hasMessage(error){return typeof error===\"object\"&&error!==null&&\"message\"in error&&typeof error.message===\"string\";};export var useTransactionFunction=function useTransactionFunction(id,send){var _useTransactionState3=useTransactionState(),_useTransactionState4=_slicedToArray(_useTransactionState3,2),transactionState=_useTransactionState4[0],setTransactionState=_useTransactionState4[1];var sendTransaction=useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var tx;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:setTransactionState({type:\"waitingForApproval\",id:id});_context.prev=1;_context.next=4;return send();case 4:tx=_context.sent;setTransactionState({type:\"waitingForConfirmation\",id:id,tx:tx});_context.next=11;break;case 8:_context.prev=8;_context.t0=_context[\"catch\"](1);if(hasMessage(_context.t0)&&_context.t0.message.includes(\"User denied transaction signature\")){setTransactionState({type:\"cancelled\",id:id});}else{console.error(_context.t0);setTransactionState({type:\"failed\",id:id,error:new Error(\"Failed to send transaction (try again)\")});}case 11:case\"end\":return _context.stop();}}},_callee,null,[[1,8]]);})),[send,id,setTransactionState]);return[sendTransaction,transactionState];};export function Transaction(_ref3){var _showFailure;var id=_ref3.id,tooltip=_ref3.tooltip,tooltipPlacement=_ref3.tooltipPlacement,showFailure=_ref3.showFailure,requires=_ref3.requires,send=_ref3.send,children=_ref3.children;var _useTransactionFuncti=useTransactionFunction(id,send),_useTransactionFuncti2=_slicedToArray(_useTransactionFuncti,2),sendTransaction=_useTransactionFuncti2[0],transactionState=_useTransactionFuncti2[1];var trigger=React.Children.only(children);var failureReasons=(requires||[]).filter(function(_ref4){var _ref5=_slicedToArray(_ref4,1),requirement=_ref5[0];return!requirement;}).map(function(_ref6){var _ref7=_slicedToArray(_ref6,2),reason=_ref7[1];return reason;});if(transactionState.type===\"waitingForApproval\"||transactionState.type===\"waitingForConfirmation\"){failureReasons.push(\"You must wait for confirmation\");}showFailure=failureReasons.length>0?(_showFailure=showFailure)!==null&&_showFailure!==void 0?_showFailure:tooltip?\"asTooltip\":\"asChildText\":undefined;var clonedTrigger=showFailure===\"asChildText\"?/*#__PURE__*/React.cloneElement(trigger,{disabled:true,variant:\"danger\"},failureReasons[0]):showFailure===\"asTooltip\"?/*#__PURE__*/React.cloneElement(trigger,{disabled:true}):/*#__PURE__*/React.cloneElement(trigger,{onClick:sendTransaction});if(showFailure===\"asTooltip\"){tooltip=failureReasons[0];}return tooltip?/*#__PURE__*/_jsx(_Fragment,{children:/*#__PURE__*/_jsx(Tooltip,{message:tooltip,placement:tooltipPlacement||\"right\",children:clonedTrigger})}):clonedTrigger;}// Doesn't work on Kovan:\n// https://github.com/MetaMask/metamask-extension/issues/5579\nvar tryToGetRevertReason=/*#__PURE__*/function(){var _ref8=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(provider,hash){var tx,result;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.prev=0;_context2.next=3;return provider.getTransaction(hash);case 3:tx=_context2.sent;_context2.next=6;return provider.call(tx,tx.blockNumber);case 6:result=_context2.sent;if(!(hexDataLength(result)%32===4&&hexDataSlice(result,0,4)===\"0x08c379a0\")){_context2.next=9;break;}return _context2.abrupt(\"return\",defaultAbiCoder.decode([\"string\"],hexDataSlice(result,4))[0]);case 9:_context2.next=14;break;case 11:_context2.prev=11;_context2.t0=_context2[\"catch\"](0);return _context2.abrupt(\"return\",undefined);case 14:case\"end\":return _context2.stop();}}},_callee2,null,[[0,11]]);}));return function tryToGetRevertReason(_x,_x2){return _ref8.apply(this,arguments);};}();var Donut=/*#__PURE__*/React.memo(CircularProgressbarWithChildren,function(_ref9,_ref10){var prev=_ref9.value;var next=_ref10.value;return prev===next;});var TransactionProgressDonut=function TransactionProgressDonut(_ref11){var state=_ref11.state;var _useState=useState(0),_useState2=_slicedToArray(_useState,2),value=_useState2[0],setValue=_useState2[1];var maxValue=1;useEffect(function(){if(state===\"confirmed\"){setTimeout(function(){return setValue(maxValue);},40);}else{setTimeout(function(){return setValue(maxValue*0.67);},20);}},[state]);return state===\"confirmed\"?/*#__PURE__*/_jsx(Donut,_objectSpread(_objectSpread({},_objectSpread({value:value,maxValue:maxValue},fastProgress)),{},{children:/*#__PURE__*/_jsx(Icon,{name:\"check\",color:\"white\",size:\"lg\"})})):state===\"failed\"||state===\"cancelled\"?/*#__PURE__*/_jsx(Donut,_objectSpread(_objectSpread({value:0},_objectSpread({maxValue:maxValue},fastProgress)),{},{children:/*#__PURE__*/_jsx(Icon,{name:\"times\",color:\"white\",size:\"lg\"})})):/*#__PURE__*/_jsx(Donut,_objectSpread(_objectSpread({},_objectSpread({value:value,maxValue:maxValue},slowProgress)),{},{children:/*#__PURE__*/_jsx(Icon,{name:\"cog\",color:\"white\",size:\"lg\",spin:true})}));};export var TransactionMonitor=function TransactionMonitor(){var _useLiquity=useLiquity(),provider=_useLiquity.provider;var _useTransactionState5=useTransactionState(),_useTransactionState6=_slicedToArray(_useTransactionState5,2),transactionState=_useTransactionState6[0],setTransactionState=_useTransactionState6[1];var id=transactionState.type!==\"idle\"?transactionState.id:undefined;var tx=transactionState.type===\"waitingForConfirmation\"?transactionState.tx:undefined;useEffect(function(){if(id&&tx){var cancelled=false;var finished=false;var txHash=tx.rawSentTransaction.hash;var waitForConfirmation=/*#__PURE__*/function(){var _ref12=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var receipt,confirmations,blockNumber,reason;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.prev=0;_context3.next=3;return tx.waitForReceipt();case 3:receipt=_context3.sent;if(!cancelled){_context3.next=6;break;}return _context3.abrupt(\"return\");case 6:confirmations=receipt.rawReceipt.confirmations;blockNumber=receipt.rawReceipt.blockNumber+confirmations-1;console.log(\"Block #\".concat(blockNumber,\" \").concat(confirmations,\"-confirms tx \").concat(txHash));console.log(\"Finish monitoring tx \".concat(txHash));finished=true;if(!(receipt.status===\"succeeded\")){_context3.next=16;break;}console.log(\"\".concat(receipt));setTransactionState({type:\"confirmedOneShot\",id:id});_context3.next=24;break;case 16:_context3.next=18;return tryToGetRevertReason(provider,txHash);case 18:reason=_context3.sent;if(!cancelled){_context3.next=21;break;}return _context3.abrupt(\"return\");case 21:console.error(\"Tx \".concat(txHash,\" failed\"));if(reason){console.error(\"Revert reason: \".concat(reason));}setTransactionState({type:\"failed\",id:id,error:new Error(reason?\"Reverted: \".concat(reason):\"Failed\")});case 24:_context3.next=33;break;case 26:_context3.prev=26;_context3.t0=_context3[\"catch\"](0);if(!cancelled){_context3.next=30;break;}return _context3.abrupt(\"return\");case 30:console.error(\"Failed to get receipt for tx \".concat(txHash));console.error(_context3.t0);setTransactionState({type:\"failed\",id:id,error:new Error(\"Failed\")});case 33:case\"end\":return _context3.stop();}}},_callee3,null,[[0,26]]);}));return function waitForConfirmation(){return _ref12.apply(this,arguments);};}();console.log(\"Start monitoring tx \".concat(txHash));waitForConfirmation();return function(){if(!finished){setTransactionState({type:\"idle\"});console.log(\"Cancel monitoring tx \".concat(txHash));cancelled=true;}};}},[provider,id,tx,setTransactionState]);useEffect(function(){if(transactionState.type===\"confirmedOneShot\"&&id){// hack: the txn confirmed state lasts 5 seconds which blocks other states, review with Dani\nsetTransactionState({type:\"confirmed\",id:id});}else if(transactionState.type===\"confirmed\"||transactionState.type===\"failed\"||transactionState.type===\"cancelled\"){var cancelled=false;setTimeout(function(){if(!cancelled){setTransactionState({type:\"idle\"});}},5000);return function(){cancelled=true;};}},[transactionState.type,setTransactionState,id]);if(transactionState.type===\"idle\"||transactionState.type===\"waitingForApproval\"){return null;}return/*#__PURE__*/_jsxs(Flex,{sx:{alignItems:\"center\",bg:transactionState.type===\"confirmed\"?\"success\":transactionState.type===\"cancelled\"?\"warning\":transactionState.type===\"failed\"?\"danger\":\"primary\",p:3,pl:4,position:\"fixed\",width:\"100vw\",bottom:0,overflow:\"hidden\"},children:[/*#__PURE__*/_jsx(Box,{sx:{mr:3,width:\"40px\",height:\"40px\"},children:/*#__PURE__*/_jsx(TransactionProgressDonut,{state:transactionState.type})}),/*#__PURE__*/_jsx(Text,{sx:{fontSize:3,color:\"white\"},children:transactionState.type===\"waitingForConfirmation\"?\"Waiting for confirmation\":transactionState.type===\"cancelled\"?\"Cancelled\":transactionState.type===\"failed\"?transactionState.error.message:\"Confirmed\"})]});};","map":{"version":3,"sources":["/Users/diegoponciano/Desktop/ryan/liquity/frontend/packages/dev-frontend/src/components/Transaction.tsx"],"names":["React","useState","useContext","useEffect","useCallback","Flex","Text","Box","hexDataSlice","hexDataLength","defaultAbiCoder","buildStyles","CircularProgressbarWithChildren","useLiquity","Icon","Tooltip","strokeWidth","circularProgressbarStyle","strokeLinecap","pathColor","trailColor","slowProgress","styles","pathTransitionDuration","fastProgress","TransactionContext","createContext","undefined","TransactionProvider","children","transactionState","type","useTransactionState","Error","useMyTransactionState","myId","id","match","hasMessage","error","message","useTransactionFunction","send","setTransactionState","sendTransaction","tx","includes","console","Transaction","tooltip","tooltipPlacement","showFailure","requires","trigger","Children","only","failureReasons","filter","requirement","map","reason","push","length","clonedTrigger","cloneElement","disabled","variant","onClick","tryToGetRevertReason","provider","hash","getTransaction","call","blockNumber","result","decode","Donut","memo","prev","value","next","TransactionProgressDonut","state","setValue","maxValue","setTimeout","TransactionMonitor","cancelled","finished","txHash","rawSentTransaction","waitForConfirmation","waitForReceipt","receipt","confirmations","rawReceipt","log","status","alignItems","bg","p","pl","position","width","bottom","overflow","mr","height","fontSize","color"],"mappings":"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","sourcesContent":["import React, { useState, useContext, useEffect, useCallback } from \"react\";\nimport { Flex, Text, Box } from \"theme-ui\";\nimport { Provider, TransactionResponse, TransactionReceipt } from \"@ethersproject/abstract-provider\";\nimport { hexDataSlice, hexDataLength } from \"@ethersproject/bytes\";\nimport { defaultAbiCoder } from \"@ethersproject/abi\";\n\nimport { buildStyles, CircularProgressbarWithChildren } from \"react-circular-progressbar\";\nimport \"react-circular-progressbar/dist/styles.css\";\n\nimport { EthersTransactionOverrides } from \"@liquity/lib-ethers\";\nimport { SentLiquityTransaction, LiquityReceipt } from \"@liquity/lib-base\";\n\nimport { useLiquity } from \"../hooks/LiquityContext\";\n\nimport { Icon } from \"./Icon\";\nimport { Tooltip, TooltipProps, Hoverable } from \"./Tooltip\";\n\nconst strokeWidth = 10;\n\nconst circularProgressbarStyle = {\n  strokeLinecap: \"butt\",\n  pathColor: \"white\",\n  trailColor: \"rgba(255, 255, 255, 0.33)\"\n};\n\nconst slowProgress = {\n  strokeWidth,\n  styles: buildStyles({\n    ...circularProgressbarStyle,\n    pathTransitionDuration: 30\n  })\n};\n\nconst fastProgress = {\n  strokeWidth,\n  styles: buildStyles({\n    ...circularProgressbarStyle,\n    pathTransitionDuration: 0.75\n  })\n};\n\ntype TransactionIdle = {\n  type: \"idle\";\n};\n\ntype TransactionFailed = {\n  type: \"failed\";\n  id: string;\n  error: Error;\n};\n\ntype TransactionWaitingForApproval = {\n  type: \"waitingForApproval\";\n  id: string;\n};\n\ntype TransactionCancelled = {\n  type: \"cancelled\";\n  id: string;\n};\n\ntype TransactionWaitingForConfirmations = {\n  type: \"waitingForConfirmation\";\n  id: string;\n  tx: SentTransaction;\n};\n\ntype TransactionConfirmed = {\n  type: \"confirmed\";\n  id: string;\n};\n\ntype TransactionConfirmedOneShot = {\n  type: \"confirmedOneShot\";\n  id: string;\n};\n\ntype TransactionState =\n  | TransactionIdle\n  | TransactionFailed\n  | TransactionWaitingForApproval\n  | TransactionCancelled\n  | TransactionWaitingForConfirmations\n  | TransactionConfirmed\n  | TransactionConfirmedOneShot;\n\nconst TransactionContext = React.createContext<\n  [TransactionState, (state: TransactionState) => void] | undefined\n>(undefined);\n\nexport const TransactionProvider: React.FC = ({ children }) => {\n  const transactionState = useState<TransactionState>({ type: \"idle\" });\n  return (\n    <TransactionContext.Provider value={transactionState}>{children}</TransactionContext.Provider>\n  );\n};\n\nconst useTransactionState = () => {\n  const transactionState = useContext(TransactionContext);\n\n  if (!transactionState) {\n    throw new Error(\"You must provide a TransactionContext via TransactionProvider\");\n  }\n\n  return transactionState;\n};\n\nexport const useMyTransactionState = (myId: string | RegExp): TransactionState => {\n  const [transactionState] = useTransactionState();\n\n  return transactionState.type !== \"idle\" &&\n    (typeof myId === \"string\" ? transactionState.id === myId : transactionState.id.match(myId))\n    ? transactionState\n    : { type: \"idle\" };\n};\n\nconst hasMessage = (error: unknown): error is { message: string } =>\n  typeof error === \"object\" &&\n  error !== null &&\n  \"message\" in error &&\n  typeof (error as { message: unknown }).message === \"string\";\n\ntype ButtonlikeProps = {\n  disabled?: boolean;\n  variant?: string;\n  onClick?: () => void;\n};\n\ntype SentTransaction = SentLiquityTransaction<\n  TransactionResponse,\n  LiquityReceipt<TransactionReceipt>\n>;\n\nexport type TransactionFunction = (\n  overrides?: EthersTransactionOverrides\n) => Promise<SentTransaction>;\n\ntype TransactionProps<C> = {\n  id: string;\n  tooltip?: string;\n  tooltipPlacement?: TooltipProps<C>[\"placement\"];\n  showFailure?: \"asTooltip\" | \"asChildText\";\n  requires?: readonly (readonly [boolean, string])[];\n  send: TransactionFunction;\n  children: C;\n};\n\nexport const useTransactionFunction = (\n  id: string,\n  send: TransactionFunction\n): [sendTransaction: () => Promise<void>, transactionState: TransactionState] => {\n  const [transactionState, setTransactionState] = useTransactionState();\n\n  const sendTransaction = useCallback(async () => {\n    setTransactionState({ type: \"waitingForApproval\", id });\n\n    try {\n      const tx = await send();\n\n      setTransactionState({\n        type: \"waitingForConfirmation\",\n        id,\n        tx\n      });\n    } catch (error) {\n      if (hasMessage(error) && error.message.includes(\"User denied transaction signature\")) {\n        setTransactionState({ type: \"cancelled\", id });\n      } else {\n        console.error(error);\n\n        setTransactionState({\n          type: \"failed\",\n          id,\n          error: new Error(\"Failed to send transaction (try again)\")\n        });\n      }\n    }\n  }, [send, id, setTransactionState]);\n\n  return [sendTransaction, transactionState];\n};\n\nexport function Transaction<C extends React.ReactElement<ButtonlikeProps & Hoverable>>({\n  id,\n  tooltip,\n  tooltipPlacement,\n  showFailure,\n  requires,\n  send,\n  children\n}: TransactionProps<C>) {\n  const [sendTransaction, transactionState] = useTransactionFunction(id, send);\n  const trigger = React.Children.only<C>(children);\n\n  const failureReasons = (requires || [])\n    .filter(([requirement]) => !requirement)\n    .map(([, reason]) => reason);\n\n  if (\n    transactionState.type === \"waitingForApproval\" ||\n    transactionState.type === \"waitingForConfirmation\"\n  ) {\n    failureReasons.push(\"You must wait for confirmation\");\n  }\n\n  showFailure =\n    failureReasons.length > 0 ? showFailure ?? (tooltip ? \"asTooltip\" : \"asChildText\") : undefined;\n\n  const clonedTrigger =\n    showFailure === \"asChildText\"\n      ? React.cloneElement(\n          trigger,\n          {\n            disabled: true,\n            variant: \"danger\"\n          },\n          failureReasons[0]\n        )\n      : showFailure === \"asTooltip\"\n      ? React.cloneElement(trigger, { disabled: true })\n      : React.cloneElement(trigger, { onClick: sendTransaction });\n\n  if (showFailure === \"asTooltip\") {\n    tooltip = failureReasons[0];\n  }\n\n  return tooltip ? (\n    <>\n      <Tooltip message={tooltip} placement={tooltipPlacement || \"right\"}>\n        {clonedTrigger}\n      </Tooltip>\n    </>\n  ) : (\n    clonedTrigger\n  );\n}\n\n// Doesn't work on Kovan:\n// https://github.com/MetaMask/metamask-extension/issues/5579\nconst tryToGetRevertReason = async (provider: Provider, hash: string) => {\n  try {\n    const tx = await provider.getTransaction(hash);\n    const result = await provider.call(tx, tx.blockNumber);\n\n    if (hexDataLength(result) % 32 === 4 && hexDataSlice(result, 0, 4) === \"0x08c379a0\") {\n      return (defaultAbiCoder.decode([\"string\"], hexDataSlice(result, 4)) as [string])[0];\n    }\n  } catch {\n    return undefined;\n  }\n};\n\nconst Donut = React.memo(\n  CircularProgressbarWithChildren,\n  ({ value: prev }, { value: next }) => prev === next\n);\n\ntype TransactionProgressDonutProps = {\n  state: TransactionState[\"type\"];\n};\n\nconst TransactionProgressDonut: React.FC<TransactionProgressDonutProps> = ({ state }) => {\n  const [value, setValue] = useState(0);\n  const maxValue = 1;\n\n  useEffect(() => {\n    if (state === \"confirmed\") {\n      setTimeout(() => setValue(maxValue), 40);\n    } else {\n      setTimeout(() => setValue(maxValue * 0.67), 20);\n    }\n  }, [state]);\n\n  return state === \"confirmed\" ? (\n    <Donut {...{ value, maxValue, ...fastProgress }}>\n      <Icon name=\"check\" color=\"white\" size=\"lg\" />\n    </Donut>\n  ) : state === \"failed\" || state === \"cancelled\" ? (\n    <Donut value={0} {...{ maxValue, ...fastProgress }}>\n      <Icon name=\"times\" color=\"white\" size=\"lg\" />\n    </Donut>\n  ) : (\n    <Donut {...{ value, maxValue, ...slowProgress }}>\n      <Icon name=\"cog\" color=\"white\" size=\"lg\" spin />\n    </Donut>\n  );\n};\n\nexport const TransactionMonitor: React.FC = () => {\n  const { provider } = useLiquity();\n  const [transactionState, setTransactionState] = useTransactionState();\n\n  const id = transactionState.type !== \"idle\" ? transactionState.id : undefined;\n  const tx = transactionState.type === \"waitingForConfirmation\" ? transactionState.tx : undefined;\n\n  useEffect(() => {\n    if (id && tx) {\n      let cancelled = false;\n      let finished = false;\n\n      const txHash = tx.rawSentTransaction.hash;\n\n      const waitForConfirmation = async () => {\n        try {\n          const receipt = await tx.waitForReceipt();\n\n          if (cancelled) {\n            return;\n          }\n\n          const { confirmations } = receipt.rawReceipt;\n          const blockNumber = receipt.rawReceipt.blockNumber + confirmations - 1;\n          console.log(`Block #${blockNumber} ${confirmations}-confirms tx ${txHash}`);\n          console.log(`Finish monitoring tx ${txHash}`);\n          finished = true;\n\n          if (receipt.status === \"succeeded\") {\n            console.log(`${receipt}`);\n\n            setTransactionState({\n              type: \"confirmedOneShot\",\n              id\n            });\n          } else {\n            const reason = await tryToGetRevertReason(provider, txHash);\n\n            if (cancelled) {\n              return;\n            }\n\n            console.error(`Tx ${txHash} failed`);\n            if (reason) {\n              console.error(`Revert reason: ${reason}`);\n            }\n\n            setTransactionState({\n              type: \"failed\",\n              id,\n              error: new Error(reason ? `Reverted: ${reason}` : \"Failed\")\n            });\n          }\n        } catch (rawError) {\n          if (cancelled) {\n            return;\n          }\n\n          console.error(`Failed to get receipt for tx ${txHash}`);\n          console.error(rawError);\n\n          setTransactionState({\n            type: \"failed\",\n            id,\n            error: new Error(\"Failed\")\n          });\n        }\n      };\n\n      console.log(`Start monitoring tx ${txHash}`);\n      waitForConfirmation();\n\n      return () => {\n        if (!finished) {\n          setTransactionState({ type: \"idle\" });\n          console.log(`Cancel monitoring tx ${txHash}`);\n          cancelled = true;\n        }\n      };\n    }\n  }, [provider, id, tx, setTransactionState]);\n\n  useEffect(() => {\n    if (transactionState.type === \"confirmedOneShot\" && id) {\n      // hack: the txn confirmed state lasts 5 seconds which blocks other states, review with Dani\n      setTransactionState({ type: \"confirmed\", id });\n    } else if (\n      transactionState.type === \"confirmed\" ||\n      transactionState.type === \"failed\" ||\n      transactionState.type === \"cancelled\"\n    ) {\n      let cancelled = false;\n\n      setTimeout(() => {\n        if (!cancelled) {\n          setTransactionState({ type: \"idle\" });\n        }\n      }, 5000);\n\n      return () => {\n        cancelled = true;\n      };\n    }\n  }, [transactionState.type, setTransactionState, id]);\n\n  if (transactionState.type === \"idle\" || transactionState.type === \"waitingForApproval\") {\n    return null;\n  }\n\n  return (\n    <Flex\n      sx={{\n        alignItems: \"center\",\n        bg:\n          transactionState.type === \"confirmed\"\n            ? \"success\"\n            : transactionState.type === \"cancelled\"\n            ? \"warning\"\n            : transactionState.type === \"failed\"\n            ? \"danger\"\n            : \"primary\",\n        p: 3,\n        pl: 4,\n        position: \"fixed\",\n        width: \"100vw\",\n        bottom: 0,\n        overflow: \"hidden\"\n      }}\n    >\n      <Box sx={{ mr: 3, width: \"40px\", height: \"40px\" }}>\n        <TransactionProgressDonut state={transactionState.type} />\n      </Box>\n\n      <Text sx={{ fontSize: 3, color: \"white\" }}>\n        {transactionState.type === \"waitingForConfirmation\"\n          ? \"Waiting for confirmation\"\n          : transactionState.type === \"cancelled\"\n          ? \"Cancelled\"\n          : transactionState.type === \"failed\"\n          ? transactionState.error.message\n          : \"Confirmed\"}\n      </Text>\n    </Flex>\n  );\n};\n"]},"metadata":{},"sourceType":"module"}