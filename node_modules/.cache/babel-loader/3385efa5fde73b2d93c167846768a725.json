{"ast":null,"code":"import _objectSpread from\"/Users/diegoponciano/Desktop/ryan/liquity/frontend/packages/dev-frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _objectWithoutProperties from\"/Users/diegoponciano/Desktop/ryan/liquity/frontend/packages/dev-frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectWithoutProperties\";import _regeneratorRuntime from\"/Users/diegoponciano/Desktop/ryan/liquity/frontend/packages/dev-frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/diegoponciano/Desktop/ryan/liquity/frontend/packages/dev-frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"/Users/diegoponciano/Desktop/ryan/liquity/frontend/packages/dev-frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/Users/diegoponciano/Desktop/ryan/liquity/frontend/packages/dev-frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import{hexlify}from\"@ethersproject/bytes\";import{Wallet}from\"@ethersproject/wallet\";import{Decimal}from\"@liquity/lib-base\";export var DisposableWalletProvider=/*#__PURE__*/function(){function DisposableWalletProvider(url,funderPrivateKey){var ethAmount=arguments.length>2&&arguments[2]!==undefined?arguments[2]:100;_classCallCheck(this,DisposableWalletProvider);this.url=void 0;this.id=0;this.wallet=void 0;this.funderWallet=void 0;this.ethAmount=void 0;this.haveFunded=false;this.url=url;this.wallet=Wallet.createRandom();this.funderWallet=new Wallet(funderPrivateKey);this.ethAmount=Decimal.from(ethAmount);}_createClass(DisposableWalletProvider,[{key:\"findWallet\",value:function findWallet(address){var wallet=[this.wallet,this.funderWallet].find(function(wallet){return wallet.address.toLowerCase()===address.toLowerCase();});if(!wallet){throw new Error(\"Unknow account \".concat(address));}return wallet;}},{key:\"fund\",value:function(){var _fund=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:return _context.abrupt(\"return\",this.send(\"eth_sendTransaction\",[{from:this.funderWallet.address,to:this.wallet.address,value:this.ethAmount.hex,gas:hexlify(21000)}]));case 1:case\"end\":return _context.stop();}}},_callee,this);}));function fund(){return _fund.apply(this,arguments);}return fund;}()},{key:\"send\",value:function(){var _send=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(method,params){var _this=this;var response,json,_json$error,message,rest,error;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:if(this.haveFunded){_context3.next=4;break;}this.haveFunded=true;_context3.next=4;return this.fund();case 4:_context3.t0=method;_context3.next=_context3.t0===\"eth_accounts\"?7:_context3.t0===\"eth_requestAccounts\"?7:_context3.t0===\"eth_sendTransaction\"?8:13;break;case 7:return _context3.abrupt(\"return\",[this.wallet.address]);case 8:_context3.t1=this;_context3.next=11;return Promise.all(params.map(/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(_ref){var from,nonce,gas,rest;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:from=_ref.from,nonce=_ref.nonce,gas=_ref.gas,rest=_objectWithoutProperties(_ref,[\"from\",\"nonce\",\"gas\"]);if(!(nonce===undefined)){_context2.next=5;break;}_context2.next=4;return _this.send(\"eth_getTransactionCount\",[from]);case 4:nonce=_context2.sent;case 5:return _context2.abrupt(\"return\",_this.findWallet(from).signTransaction(_objectSpread(_objectSpread({from:from,nonce:nonce},gas!==undefined?{gasLimit:gas}:{}),rest)));case 6:case\"end\":return _context2.stop();}}},_callee2);}));return function(_x3){return _ref2.apply(this,arguments);};}()));case 11:_context3.t2=_context3.sent;return _context3.abrupt(\"return\",_context3.t1.send.call(_context3.t1,\"eth_sendRawTransaction\",_context3.t2));case 13:_context3.next=15;return fetch(this.url,{method:\"POST\",headers:{\"Content-Type\":\"application/json\"},body:JSON.stringify({method:method,params:params,id:this.id++,jsonrpc:\"2.0\"})});case 15:response=_context3.sent;_context3.next=18;return response.json();case 18:json=_context3.sent;if(!json.error){_context3.next=23;break;}_json$error=json.error,message=_json$error.message,rest=_objectWithoutProperties(_json$error,[\"message\"]);error=new Error(\"\".concat(message,\" \").concat(JSON.stringify(rest)));throw Object.assign(error,rest);case 23:return _context3.abrupt(\"return\",json.result);case 24:case\"end\":return _context3.stop();}}},_callee3,this);}));function send(_x,_x2){return _send.apply(this,arguments);}return send;}()},{key:\"request\",value:function request(_ref3){var method=_ref3.method,params=_ref3.params;return this.send(method,params);}}]);return DisposableWalletProvider;}();","map":{"version":3,"sources":["/Users/diegoponciano/Desktop/ryan/liquity/frontend/packages/dev-frontend/src/testUtils/DisposableWalletProvider.ts"],"names":["hexlify","Wallet","Decimal","DisposableWalletProvider","url","funderPrivateKey","ethAmount","id","wallet","funderWallet","haveFunded","createRandom","from","address","find","toLowerCase","Error","send","to","value","hex","gas","method","params","fund","Promise","all","map","nonce","rest","undefined","findWallet","signTransaction","gasLimit","fetch","headers","body","JSON","stringify","jsonrpc","response","json","error","message","Object","assign","result"],"mappings":"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","sourcesContent":["import { hexlify } from \"@ethersproject/bytes\";\nimport { Wallet } from \"@ethersproject/wallet\";\n\nimport { Decimal, Decimalish } from \"@liquity/lib-base\";\n\nexport class DisposableWalletProvider {\n  private readonly url: string;\n  private id: number = 0;\n\n  private readonly wallet: Wallet;\n  private readonly funderWallet: Wallet;\n\n  private readonly ethAmount: Decimal;\n  private haveFunded = false;\n\n  constructor(url: string, funderPrivateKey: string, ethAmount: Decimalish = 100) {\n    this.url = url;\n    this.wallet = Wallet.createRandom();\n    this.funderWallet = new Wallet(funderPrivateKey);\n    this.ethAmount = Decimal.from(ethAmount);\n  }\n\n  private findWallet(address: string) {\n    const wallet = [this.wallet, this.funderWallet].find(\n      wallet => wallet.address.toLowerCase() === address.toLowerCase()\n    );\n\n    if (!wallet) {\n      throw new Error(`Unknow account ${address}`);\n    }\n\n    return wallet;\n  }\n\n  private async fund() {\n    return this.send(\"eth_sendTransaction\", [\n      {\n        from: this.funderWallet.address,\n        to: this.wallet.address,\n        value: this.ethAmount.hex,\n        gas: hexlify(21000)\n      }\n    ]);\n\n    // TODO maybe wait for tx to be mined (not a problem on devchains though)\n  }\n\n  async send(method: string, params: any[]): Promise<any> {\n    if (!this.haveFunded) {\n      this.haveFunded = true;\n      await this.fund();\n    }\n\n    switch (method) {\n      case \"eth_accounts\":\n      case \"eth_requestAccounts\":\n        return [this.wallet.address];\n\n      case \"eth_sendTransaction\":\n        return this.send(\n          \"eth_sendRawTransaction\",\n          await Promise.all(\n            params.map(async ({ from, nonce, gas, ...rest }) => {\n              if (nonce === undefined) {\n                nonce = await this.send(\"eth_getTransactionCount\", [from]);\n              }\n\n              return this.findWallet(from).signTransaction({\n                from,\n                nonce,\n                ...(gas !== undefined ? { gasLimit: gas } : {}),\n                ...rest\n              });\n            })\n          )\n        );\n    }\n\n    //console.log({ method, params });\n\n    const response = await fetch(this.url, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\"\n      },\n      body: JSON.stringify({\n        method: method,\n        params: params,\n        id: this.id++,\n        jsonrpc: \"2.0\"\n      })\n    });\n\n    const json = await response.json();\n\n    //console.log(json);\n\n    if (json.error) {\n      const { message, ...rest } = json.error;\n      const error = new Error(`${message} ${JSON.stringify(rest)}`);\n      throw Object.assign(error, rest);\n    }\n\n    return json.result;\n  }\n\n  request({ method, params }: { method: string; params: any[] }) {\n    return this.send(method, params);\n  }\n}\n"]},"metadata":{},"sourceType":"module"}