{"ast":null,"code":"import _slicedToArray from\"/Users/diegoponciano/Desktop/ryan/liquity/frontend/packages/dev-frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useState,useEffect,useCallback}from\"react\";import CopyToClipboard from\"react-copy-to-clipboard\";import{Card,Button,Text,Box,Heading,Flex}from\"theme-ui\";import{Percent,MINIMUM_COLLATERAL_RATIO,CRITICAL_COLLATERAL_RATIO}from\"@liquity/lib-base\";import{useLiquitySelector}from\"@liquity/lib-react\";import{shortenAddress}from\"../utils/shortenAddress\";import{useLiquity}from\"../hooks/LiquityContext\";import{COIN}from\"../strings\";import{Icon}from\"./Icon\";import{LoadingOverlay}from\"./LoadingOverlay\";import{Transaction}from\"./Transaction\";import{Tooltip}from\"./Tooltip\";import{Abbreviation}from\"./Abbreviation\";import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";var rowHeight=\"40px\";var liquidatableInNormalMode=function liquidatableInNormalMode(trove,price){return[trove.collateralRatioIsBelowMinimum(price),\"Collateral ratio not low enough\"];};var liquidatableInRecoveryMode=function liquidatableInRecoveryMode(trove,price,totalCollateralRatio,lusdInStabilityPool){var collateralRatio=trove.collateralRatio(price);if(collateralRatio.gte(MINIMUM_COLLATERAL_RATIO)&&collateralRatio.lt(totalCollateralRatio)){return[trove.debt.lte(lusdInStabilityPool),\"There's not enough LUSD in the Stability pool to cover the debt\"];}else{return liquidatableInNormalMode(trove,price);}};var select=function select(_ref){var numberOfTroves=_ref.numberOfTroves,price=_ref.price,total=_ref.total,lusdInStabilityPool=_ref.lusdInStabilityPool,blockTag=_ref.blockTag;return{numberOfTroves:numberOfTroves,price:price,recoveryMode:total.collateralRatioIsBelowCritical(price),totalCollateralRatio:total.collateralRatio(price),lusdInStabilityPool:lusdInStabilityPool,blockTag:blockTag};};export var RiskyTroves=function RiskyTroves(_ref2){var pageSize=_ref2.pageSize;var _useLiquitySelector=useLiquitySelector(select),blockTag=_useLiquitySelector.blockTag,numberOfTroves=_useLiquitySelector.numberOfTroves,recoveryMode=_useLiquitySelector.recoveryMode,totalCollateralRatio=_useLiquitySelector.totalCollateralRatio,lusdInStabilityPool=_useLiquitySelector.lusdInStabilityPool,price=_useLiquitySelector.price;var _useLiquity=useLiquity(),liquity=_useLiquity.liquity;var _useState=useState(true),_useState2=_slicedToArray(_useState,2),loading=_useState2[0],setLoading=_useState2[1];var _useState3=useState(),_useState4=_slicedToArray(_useState3,2),troves=_useState4[0],setTroves=_useState4[1];var _useState5=useState({}),_useState6=_slicedToArray(_useState5,2),reload=_useState6[0],setReload=_useState6[1];var forceReload=useCallback(function(){return setReload({});},[]);var _useState7=useState(0),_useState8=_slicedToArray(_useState7,2),page=_useState8[0],setPage=_useState8[1];var numberOfPages=Math.ceil(numberOfTroves/pageSize)||1;var clampedPage=Math.min(page,numberOfPages-1);var nextPage=function nextPage(){if(clampedPage<numberOfPages-1){setPage(clampedPage+1);}};var previousPage=function previousPage(){if(clampedPage>0){setPage(clampedPage-1);}};useEffect(function(){if(page!==clampedPage){setPage(clampedPage);}},[page,clampedPage]);useEffect(function(){var mounted=true;setLoading(true);liquity.getTroves({first:pageSize,sortedBy:\"ascendingCollateralRatio\",startingAt:clampedPage*pageSize},{blockTag:blockTag}).then(function(troves){if(mounted){setTroves(troves);setLoading(false);}});return function(){mounted=false;};// Omit blockTag from deps on purpose\n// eslint-disable-next-line\n},[liquity,clampedPage,pageSize,reload]);useEffect(function(){forceReload();},[forceReload,numberOfTroves]);var _useState9=useState(),_useState10=_slicedToArray(_useState9,2),copied=_useState10[0],setCopied=_useState10[1];useEffect(function(){if(copied!==undefined){var cancelled=false;setTimeout(function(){if(!cancelled){setCopied(undefined);}},2000);return function(){cancelled=true;};}},[copied]);return/*#__PURE__*/_jsxs(Card,{sx:{width:\"100%\"},children:[/*#__PURE__*/_jsxs(Heading,{children:[/*#__PURE__*/_jsx(Abbreviation,{short:\"Troves\",children:\"Risky Troves\"}),/*#__PURE__*/_jsxs(Flex,{sx:{alignItems:\"center\"},children:[numberOfTroves!==0&&/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsxs(Abbreviation,{short:\"page \".concat(clampedPage+1,\" / \").concat(numberOfPages),sx:{mr:[0,3],fontWeight:\"body\",fontSize:[1,2],letterSpacing:[-1,0]},children:[clampedPage*pageSize+1,\"-\",Math.min((clampedPage+1)*pageSize,numberOfTroves),\" \",\"of \",numberOfTroves]}),/*#__PURE__*/_jsx(Button,{variant:\"titleIcon\",onClick:previousPage,disabled:clampedPage<=0,children:/*#__PURE__*/_jsx(Icon,{name:\"chevron-left\",size:\"lg\"})}),/*#__PURE__*/_jsx(Button,{variant:\"titleIcon\",onClick:nextPage,disabled:clampedPage>=numberOfPages-1,children:/*#__PURE__*/_jsx(Icon,{name:\"chevron-right\",size:\"lg\"})})]}),/*#__PURE__*/_jsx(Button,{variant:\"titleIcon\",sx:{opacity:loading?0:1,ml:[0,3]},onClick:forceReload,children:/*#__PURE__*/_jsx(Icon,{name:\"redo\",size:\"lg\"})})]})]}),!troves||troves.length===0?/*#__PURE__*/_jsx(Box,{sx:{p:[2,3]},children:/*#__PURE__*/_jsx(Box,{sx:{p:4,fontSize:3,textAlign:\"center\"},children:!troves?\"Loading...\":\"There are no Troves yet\"})}):/*#__PURE__*/_jsx(Box,{sx:{p:[2,3]},children:/*#__PURE__*/_jsxs(Box,{as:\"table\",sx:{mt:2,pl:[1,4],width:\"100%\",textAlign:\"center\",lineHeight:1.15},children:[/*#__PURE__*/_jsxs(\"colgroup\",{children:[/*#__PURE__*/_jsx(\"col\",{style:{width:\"50px\"}}),/*#__PURE__*/_jsx(\"col\",{}),/*#__PURE__*/_jsx(\"col\",{}),/*#__PURE__*/_jsx(\"col\",{}),/*#__PURE__*/_jsx(\"col\",{style:{width:rowHeight}})]}),/*#__PURE__*/_jsx(\"thead\",{children:/*#__PURE__*/_jsxs(\"tr\",{children:[/*#__PURE__*/_jsx(\"th\",{children:\"Owner\"}),/*#__PURE__*/_jsxs(\"th\",{children:[/*#__PURE__*/_jsx(Abbreviation,{short:\"Coll.\",children:\"Collateral\"}),/*#__PURE__*/_jsx(Box,{sx:{fontSize:[0,1],fontWeight:\"body\",opacity:0.5},children:\"ETH\"})]}),/*#__PURE__*/_jsxs(\"th\",{children:[\"Debt\",/*#__PURE__*/_jsx(Box,{sx:{fontSize:[0,1],fontWeight:\"body\",opacity:0.5},children:COIN})]}),/*#__PURE__*/_jsxs(\"th\",{children:[\"Coll.\",/*#__PURE__*/_jsx(\"br\",{}),\"Ratio\"]}),/*#__PURE__*/_jsx(\"th\",{})]})}),/*#__PURE__*/_jsx(\"tbody\",{children:troves.map(function(trove){return!trove.isEmpty&&/*#__PURE__*/ // making sure the Trove hasn't been liquidated\n// (TODO: remove check after we can fetch multiple Troves in one call)\n_jsxs(\"tr\",{children:[/*#__PURE__*/_jsxs(\"td\",{style:{display:\"flex\",alignItems:\"center\",height:rowHeight},children:[/*#__PURE__*/_jsx(Tooltip,{message:trove.ownerAddress,placement:\"top\",children:/*#__PURE__*/_jsxs(Text,{variant:\"address\",sx:{width:[\"73px\",\"unset\"],overflow:\"hidden\",position:\"relative\"},children:[shortenAddress(trove.ownerAddress),/*#__PURE__*/_jsx(Box,{sx:{display:[\"block\",\"none\"],position:\"absolute\",top:0,right:0,width:\"50px\",height:\"100%\",background:\"linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,1) 100%)\"}})]})}),/*#__PURE__*/_jsx(CopyToClipboard,{text:trove.ownerAddress,onCopy:function onCopy(){return setCopied(trove.ownerAddress);},children:/*#__PURE__*/_jsx(Button,{variant:\"icon\",sx:{width:\"24px\",height:\"24px\"},children:/*#__PURE__*/_jsx(Icon,{name:copied===trove.ownerAddress?\"clipboard-check\":\"clipboard\",size:\"sm\"})})})]}),/*#__PURE__*/_jsx(\"td\",{children:/*#__PURE__*/_jsx(Abbreviation,{short:trove.collateral.shorten(),children:trove.collateral.prettify(4)})}),/*#__PURE__*/_jsx(\"td\",{children:/*#__PURE__*/_jsx(Abbreviation,{short:trove.debt.shorten(),children:trove.debt.prettify()})}),/*#__PURE__*/_jsx(\"td\",{children:function(collateralRatio){return/*#__PURE__*/_jsx(Text,{color:collateralRatio.gt(CRITICAL_COLLATERAL_RATIO)?\"success\":collateralRatio.gt(1.2)?\"warning\":\"danger\",children:new Percent(collateralRatio).prettify()});}(trove.collateralRatio(price))}),/*#__PURE__*/_jsx(\"td\",{children:/*#__PURE__*/_jsx(Transaction,{id:\"liquidate-\".concat(trove.ownerAddress),tooltip:\"Liquidate\",requires:[recoveryMode?liquidatableInRecoveryMode(trove,price,totalCollateralRatio,lusdInStabilityPool):liquidatableInNormalMode(trove,price)],send:liquity.send.liquidate.bind(liquity.send,trove.ownerAddress),children:/*#__PURE__*/_jsx(Button,{variant:\"dangerIcon\",children:/*#__PURE__*/_jsx(Icon,{name:\"trash\"})})})})]},trove.ownerAddress);})})]})}),loading&&/*#__PURE__*/_jsx(LoadingOverlay,{})]});};","map":{"version":3,"sources":["/Users/diegoponciano/Desktop/ryan/liquity/frontend/packages/dev-frontend/src/components/RiskyTroves.tsx"],"names":["React","useState","useEffect","useCallback","CopyToClipboard","Card","Button","Text","Box","Heading","Flex","Percent","MINIMUM_COLLATERAL_RATIO","CRITICAL_COLLATERAL_RATIO","useLiquitySelector","shortenAddress","useLiquity","COIN","Icon","LoadingOverlay","Transaction","Tooltip","Abbreviation","rowHeight","liquidatableInNormalMode","trove","price","collateralRatioIsBelowMinimum","liquidatableInRecoveryMode","totalCollateralRatio","lusdInStabilityPool","collateralRatio","gte","lt","debt","lte","select","numberOfTroves","total","blockTag","recoveryMode","collateralRatioIsBelowCritical","RiskyTroves","pageSize","liquity","loading","setLoading","troves","setTroves","reload","setReload","forceReload","page","setPage","numberOfPages","Math","ceil","clampedPage","min","nextPage","previousPage","mounted","getTroves","first","sortedBy","startingAt","then","copied","setCopied","undefined","cancelled","setTimeout","width","alignItems","mr","fontWeight","fontSize","letterSpacing","opacity","ml","length","p","textAlign","mt","pl","lineHeight","map","isEmpty","display","height","ownerAddress","overflow","position","top","right","background","collateral","shorten","prettify","gt","send","liquidate","bind"],"mappings":"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","sourcesContent":["import React, { useState, useEffect, useCallback } from \"react\";\nimport CopyToClipboard from \"react-copy-to-clipboard\";\nimport { Card, Button, Text, Box, Heading, Flex } from \"theme-ui\";\n\nimport {\n  Percent,\n  MINIMUM_COLLATERAL_RATIO,\n  CRITICAL_COLLATERAL_RATIO,\n  UserTrove,\n  Decimal\n} from \"@liquity/lib-base\";\nimport { BlockPolledLiquityStoreState } from \"@liquity/lib-ethers\";\nimport { useLiquitySelector } from \"@liquity/lib-react\";\n\nimport { shortenAddress } from \"../utils/shortenAddress\";\nimport { useLiquity } from \"../hooks/LiquityContext\";\nimport { COIN } from \"../strings\";\n\nimport { Icon } from \"./Icon\";\nimport { LoadingOverlay } from \"./LoadingOverlay\";\nimport { Transaction } from \"./Transaction\";\nimport { Tooltip } from \"./Tooltip\";\nimport { Abbreviation } from \"./Abbreviation\";\n\nconst rowHeight = \"40px\";\n\nconst liquidatableInNormalMode = (trove: UserTrove, price: Decimal) =>\n  [trove.collateralRatioIsBelowMinimum(price), \"Collateral ratio not low enough\"] as const;\n\nconst liquidatableInRecoveryMode = (\n  trove: UserTrove,\n  price: Decimal,\n  totalCollateralRatio: Decimal,\n  lusdInStabilityPool: Decimal\n) => {\n  const collateralRatio = trove.collateralRatio(price);\n\n  if (collateralRatio.gte(MINIMUM_COLLATERAL_RATIO) && collateralRatio.lt(totalCollateralRatio)) {\n    return [\n      trove.debt.lte(lusdInStabilityPool),\n      \"There's not enough LUSD in the Stability pool to cover the debt\"\n    ] as const;\n  } else {\n    return liquidatableInNormalMode(trove, price);\n  }\n};\n\ntype RiskyTrovesProps = {\n  pageSize: number;\n};\n\nconst select = ({\n  numberOfTroves,\n  price,\n  total,\n  lusdInStabilityPool,\n  blockTag\n}: BlockPolledLiquityStoreState) => ({\n  numberOfTroves,\n  price,\n  recoveryMode: total.collateralRatioIsBelowCritical(price),\n  totalCollateralRatio: total.collateralRatio(price),\n  lusdInStabilityPool,\n  blockTag\n});\n\nexport const RiskyTroves: React.FC<RiskyTrovesProps> = ({ pageSize }) => {\n  const {\n    blockTag,\n    numberOfTroves,\n    recoveryMode,\n    totalCollateralRatio,\n    lusdInStabilityPool,\n    price\n  } = useLiquitySelector(select);\n  const { liquity } = useLiquity();\n\n  const [loading, setLoading] = useState(true);\n  const [troves, setTroves] = useState<UserTrove[]>();\n\n  const [reload, setReload] = useState({});\n  const forceReload = useCallback(() => setReload({}), []);\n\n  const [page, setPage] = useState(0);\n  const numberOfPages = Math.ceil(numberOfTroves / pageSize) || 1;\n  const clampedPage = Math.min(page, numberOfPages - 1);\n\n  const nextPage = () => {\n    if (clampedPage < numberOfPages - 1) {\n      setPage(clampedPage + 1);\n    }\n  };\n\n  const previousPage = () => {\n    if (clampedPage > 0) {\n      setPage(clampedPage - 1);\n    }\n  };\n\n  useEffect(() => {\n    if (page !== clampedPage) {\n      setPage(clampedPage);\n    }\n  }, [page, clampedPage]);\n\n  useEffect(() => {\n    let mounted = true;\n\n    setLoading(true);\n\n    liquity\n      .getTroves(\n        {\n          first: pageSize,\n          sortedBy: \"ascendingCollateralRatio\",\n          startingAt: clampedPage * pageSize\n        },\n        { blockTag }\n      )\n      .then(troves => {\n        if (mounted) {\n          setTroves(troves);\n          setLoading(false);\n        }\n      });\n\n    return () => {\n      mounted = false;\n    };\n    // Omit blockTag from deps on purpose\n    // eslint-disable-next-line\n  }, [liquity, clampedPage, pageSize, reload]);\n\n  useEffect(() => {\n    forceReload();\n  }, [forceReload, numberOfTroves]);\n\n  const [copied, setCopied] = useState<string>();\n\n  useEffect(() => {\n    if (copied !== undefined) {\n      let cancelled = false;\n\n      setTimeout(() => {\n        if (!cancelled) {\n          setCopied(undefined);\n        }\n      }, 2000);\n\n      return () => {\n        cancelled = true;\n      };\n    }\n  }, [copied]);\n\n  return (\n    <Card sx={{ width: \"100%\" }}>\n      <Heading>\n        <Abbreviation short=\"Troves\">Risky Troves</Abbreviation>\n\n        <Flex sx={{ alignItems: \"center\" }}>\n          {numberOfTroves !== 0 && (\n            <>\n              <Abbreviation\n                short={`page ${clampedPage + 1} / ${numberOfPages}`}\n                sx={{ mr: [0, 3], fontWeight: \"body\", fontSize: [1, 2], letterSpacing: [-1, 0] }}\n              >\n                {clampedPage * pageSize + 1}-{Math.min((clampedPage + 1) * pageSize, numberOfTroves)}{\" \"}\n                of {numberOfTroves}\n              </Abbreviation>\n\n              <Button variant=\"titleIcon\" onClick={previousPage} disabled={clampedPage <= 0}>\n                <Icon name=\"chevron-left\" size=\"lg\" />\n              </Button>\n\n              <Button\n                variant=\"titleIcon\"\n                onClick={nextPage}\n                disabled={clampedPage >= numberOfPages - 1}\n              >\n                <Icon name=\"chevron-right\" size=\"lg\" />\n              </Button>\n            </>\n          )}\n\n          <Button\n            variant=\"titleIcon\"\n            sx={{ opacity: loading ? 0 : 1, ml: [0, 3] }}\n            onClick={forceReload}\n          >\n            <Icon name=\"redo\" size=\"lg\" />\n          </Button>\n        </Flex>\n      </Heading>\n\n      {!troves || troves.length === 0 ? (\n        <Box sx={{ p: [2, 3] }}>\n          <Box sx={{ p: 4, fontSize: 3, textAlign: \"center\" }}>\n            {!troves ? \"Loading...\" : \"There are no Troves yet\"}\n          </Box>\n        </Box>\n      ) : (\n        <Box sx={{ p: [2, 3] }}>\n          <Box\n            as=\"table\"\n            sx={{\n              mt: 2,\n              pl: [1, 4],\n              width: \"100%\",\n\n              textAlign: \"center\",\n              lineHeight: 1.15\n            }}\n          >\n            <colgroup>\n              <col style={{ width: \"50px\" }} />\n              <col />\n              <col />\n              <col />\n              <col style={{ width: rowHeight }} />\n            </colgroup>\n\n            <thead>\n              <tr>\n                <th>Owner</th>\n                <th>\n                  <Abbreviation short=\"Coll.\">Collateral</Abbreviation>\n                  <Box sx={{ fontSize: [0, 1], fontWeight: \"body\", opacity: 0.5 }}>ETH</Box>\n                </th>\n                <th>\n                  Debt\n                  <Box sx={{ fontSize: [0, 1], fontWeight: \"body\", opacity: 0.5 }}>{COIN}</Box>\n                </th>\n                <th>\n                  Coll.\n                  <br />\n                  Ratio\n                </th>\n                <th></th>\n              </tr>\n            </thead>\n\n            <tbody>\n              {troves.map(\n                trove =>\n                  !trove.isEmpty && ( // making sure the Trove hasn't been liquidated\n                    // (TODO: remove check after we can fetch multiple Troves in one call)\n                    <tr key={trove.ownerAddress}>\n                      <td\n                        style={{\n                          display: \"flex\",\n                          alignItems: \"center\",\n                          height: rowHeight\n                        }}\n                      >\n                        <Tooltip message={trove.ownerAddress} placement=\"top\">\n                          <Text\n                            variant=\"address\"\n                            sx={{\n                              width: [\"73px\", \"unset\"],\n                              overflow: \"hidden\",\n                              position: \"relative\"\n                            }}\n                          >\n                            {shortenAddress(trove.ownerAddress)}\n                            <Box\n                              sx={{\n                                display: [\"block\", \"none\"],\n                                position: \"absolute\",\n                                top: 0,\n                                right: 0,\n                                width: \"50px\",\n                                height: \"100%\",\n                                background:\n                                  \"linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,1) 100%)\"\n                              }}\n                            />\n                          </Text>\n                        </Tooltip>\n\n                        <CopyToClipboard\n                          text={trove.ownerAddress}\n                          onCopy={() => setCopied(trove.ownerAddress)}\n                        >\n                          <Button variant=\"icon\" sx={{ width: \"24px\", height: \"24px\" }}>\n                            <Icon\n                              name={copied === trove.ownerAddress ? \"clipboard-check\" : \"clipboard\"}\n                              size=\"sm\"\n                            />\n                          </Button>\n                        </CopyToClipboard>\n                      </td>\n                      <td>\n                        <Abbreviation short={trove.collateral.shorten()}>\n                          {trove.collateral.prettify(4)}\n                        </Abbreviation>\n                      </td>\n                      <td>\n                        <Abbreviation short={trove.debt.shorten()}>\n                          {trove.debt.prettify()}\n                        </Abbreviation>\n                      </td>\n                      <td>\n                        {(collateralRatio => (\n                          <Text\n                            color={\n                              collateralRatio.gt(CRITICAL_COLLATERAL_RATIO)\n                                ? \"success\"\n                                : collateralRatio.gt(1.2)\n                                ? \"warning\"\n                                : \"danger\"\n                            }\n                          >\n                            {new Percent(collateralRatio).prettify()}\n                          </Text>\n                        ))(trove.collateralRatio(price))}\n                      </td>\n                      <td>\n                        <Transaction\n                          id={`liquidate-${trove.ownerAddress}`}\n                          tooltip=\"Liquidate\"\n                          requires={[\n                            recoveryMode\n                              ? liquidatableInRecoveryMode(\n                                  trove,\n                                  price,\n                                  totalCollateralRatio,\n                                  lusdInStabilityPool\n                                )\n                              : liquidatableInNormalMode(trove, price)\n                          ]}\n                          send={liquity.send.liquidate.bind(liquity.send, trove.ownerAddress)}\n                        >\n                          <Button variant=\"dangerIcon\">\n                            <Icon name=\"trash\" />\n                          </Button>\n                        </Transaction>\n                      </td>\n                    </tr>\n                  )\n              )}\n            </tbody>\n          </Box>\n        </Box>\n      )}\n\n      {loading && <LoadingOverlay />}\n    </Card>\n  );\n};\n"]},"metadata":{},"sourceType":"module"}