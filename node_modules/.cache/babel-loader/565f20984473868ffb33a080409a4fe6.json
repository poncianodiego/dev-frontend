{"ast":null,"code":"import _regeneratorRuntime from\"/Users/diegoponciano/Desktop/ryan/liquity/frontend/packages/dev-frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/diegoponciano/Desktop/ryan/liquity/frontend/packages/dev-frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import{Decimal}from\"@liquity/lib-base\";var uniswapQuery=function uniswapQuery(lqtyTokenAddress,uniTokenAddress){return\"{\\n  token(id: \\\"\".concat(lqtyTokenAddress.toLowerCase(),\"\\\") {\\n    derivedETH\\n  },\\n  bundle(id: 1) {\\n    ethPrice\\n  },\\n  pair(id: \\\"\").concat(uniTokenAddress.toLowerCase(),\"\\\") {\\n    totalSupply\\n    reserveUSD\\n  }\\n}\");};export function fetchPrices(_x,_x2){return _fetchPrices.apply(this,arguments);}function _fetchPrices(){_fetchPrices=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(lqtyTokenAddress,uniTokenAddress){var _data$token,_data$pair,_data$pair2,_data$bundle;var response,_yield$response$json,data,errors,ethPriceUSD,lqtyPriceUSD,uniLpPriceUSD;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return window.fetch(\"https://api.thegraph.com/subgraphs/name/uniswap/uniswap-v2\",{method:\"POST\",headers:{\"content-type\":\"application/json\"},body:JSON.stringify({query:uniswapQuery(lqtyTokenAddress,uniTokenAddress),variables:null})});case 2:response=_context.sent;if(response.ok){_context.next=5;break;}return _context.abrupt(\"return\",Promise.reject(\"Network error connecting to Uniswap subgraph\"));case 5:_context.next=7;return response.json();case 7:_yield$response$json=_context.sent;data=_yield$response$json.data;errors=_yield$response$json.errors;if(!errors){_context.next=12;break;}return _context.abrupt(\"return\",Promise.reject(errors));case 12:if(!(typeof(data===null||data===void 0?void 0:(_data$token=data.token)===null||_data$token===void 0?void 0:_data$token.derivedETH)===\"string\"&&typeof(data===null||data===void 0?void 0:(_data$pair=data.pair)===null||_data$pair===void 0?void 0:_data$pair.reserveUSD)===\"string\"&&typeof(data===null||data===void 0?void 0:(_data$pair2=data.pair)===null||_data$pair2===void 0?void 0:_data$pair2.totalSupply)===\"string\"&&typeof(data===null||data===void 0?void 0:(_data$bundle=data.bundle)===null||_data$bundle===void 0?void 0:_data$bundle.ethPrice)===\"string\")){_context.next=17;break;}ethPriceUSD=Decimal.from(data.bundle.ethPrice);lqtyPriceUSD=Decimal.from(data.token.derivedETH).mul(ethPriceUSD);uniLpPriceUSD=Decimal.from(data.pair.reserveUSD).div(Decimal.from(data.pair.totalSupply));return _context.abrupt(\"return\",{lqtyPriceUSD:lqtyPriceUSD,uniLpPriceUSD:uniLpPriceUSD});case 17:return _context.abrupt(\"return\",Promise.reject(\"Uniswap doesn't have the required data to calculate yield\"));case 18:case\"end\":return _context.stop();}}},_callee);}));return _fetchPrices.apply(this,arguments);}","map":{"version":3,"sources":["/Users/diegoponciano/Desktop/ryan/liquity/frontend/packages/dev-frontend/src/components/Farm/context/fetchPrices.ts"],"names":["Decimal","uniswapQuery","lqtyTokenAddress","uniTokenAddress","toLowerCase","fetchPrices","window","fetch","method","headers","body","JSON","stringify","query","variables","response","ok","Promise","reject","json","data","errors","token","derivedETH","pair","reserveUSD","totalSupply","bundle","ethPrice","ethPriceUSD","from","lqtyPriceUSD","mul","uniLpPriceUSD","div"],"mappings":"2XAAA,OAASA,OAAT,KAAwB,mBAAxB,CAkBA,GAAMC,CAAAA,YAAY,CAAG,QAAfA,CAAAA,YAAe,CAACC,gBAAD,CAA2BC,eAA3B,mCACND,gBAAgB,CAACE,WAAjB,EADM,6FAOPD,eAAe,CAACC,WAAhB,EAPO,oDAArB,CAaA,eAAsBC,CAAAA,WAAtB,oD,6FAAO,iBAA2BH,gBAA3B,CAAqDC,eAArD,iRACkBG,CAAAA,MAAM,CAACC,KAAP,CAAa,4DAAb,CAA2E,CAChGC,MAAM,CAAE,MADwF,CAEhGC,OAAO,CAAE,CACP,eAAgB,kBADT,CAFuF,CAKhGC,IAAI,CAAEC,IAAI,CAACC,SAAL,CAAe,CACnBC,KAAK,CAAEZ,YAAY,CAACC,gBAAD,CAAmBC,eAAnB,CADA,CAEnBW,SAAS,CAAE,IAFQ,CAAf,CAL0F,CAA3E,CADlB,QACCC,QADD,kBAYAA,QAAQ,CAACC,EAZT,yDAaIC,OAAO,CAACC,MAAR,CAAe,8CAAf,CAbJ,+BAgB2CH,CAAAA,QAAQ,CAACI,IAAT,EAhB3C,2CAgBGC,IAhBH,sBAgBGA,IAhBH,CAgBSC,MAhBT,sBAgBSA,MAhBT,KAkBDA,MAlBC,0DAmBIJ,OAAO,CAACC,MAAR,CAAeG,MAAf,CAnBJ,eAuBH,OAAOD,IAAP,SAAOA,IAAP,8BAAOA,IAAI,CAAEE,KAAb,sCAAO,YAAaC,UAApB,IAAmC,QAAnC,EACA,OAAOH,IAAP,SAAOA,IAAP,6BAAOA,IAAI,CAAEI,IAAb,qCAAO,WAAYC,UAAnB,IAAkC,QADlC,EAEA,OAAOL,IAAP,SAAOA,IAAP,8BAAOA,IAAI,CAAEI,IAAb,sCAAO,YAAYE,WAAnB,IAAmC,QAFnC,EAGA,OAAON,IAAP,SAAOA,IAAP,+BAAOA,IAAI,CAAEO,MAAb,uCAAO,aAAcC,QAArB,IAAkC,QA1B/B,2BA4BGC,WA5BH,CA4BiB7B,OAAO,CAAC8B,IAAR,CAAaV,IAAI,CAACO,MAAL,CAAYC,QAAzB,CA5BjB,CA6BGG,YA7BH,CA6BkB/B,OAAO,CAAC8B,IAAR,CAAaV,IAAI,CAACE,KAAL,CAAWC,UAAxB,EAAoCS,GAApC,CAAwCH,WAAxC,CA7BlB,CA8BGI,aA9BH,CA8BmBjC,OAAO,CAAC8B,IAAR,CAAaV,IAAI,CAACI,IAAL,CAAUC,UAAvB,EAAmCS,GAAnC,CACpBlC,OAAO,CAAC8B,IAAR,CAAaV,IAAI,CAACI,IAAL,CAAUE,WAAvB,CADoB,CA9BnB,iCAkCI,CAAEK,YAAY,CAAZA,YAAF,CAAgBE,aAAa,CAAbA,aAAhB,CAlCJ,0CAqCEhB,OAAO,CAACC,MAAR,CAAe,2DAAf,CArCF,yD","sourcesContent":["import { Decimal } from \"@liquity/lib-base\";\n\ntype UniswapResponse = {\n  data?: {\n    bundle: {\n      ethPrice: string;\n    } | null;\n    token: {\n      derivedETH: string;\n    } | null;\n    pair: {\n      reserveUSD: string;\n      totalSupply: string;\n    } | null;\n  };\n  errors?: Array<{ message: string }>;\n};\n\nconst uniswapQuery = (lqtyTokenAddress: string, uniTokenAddress: string) => `{\n  token(id: \"${lqtyTokenAddress.toLowerCase()}\") {\n    derivedETH\n  },\n  bundle(id: 1) {\n    ethPrice\n  },\n  pair(id: \"${uniTokenAddress.toLowerCase()}\") {\n    totalSupply\n    reserveUSD\n  }\n}`;\n\nexport async function fetchPrices(lqtyTokenAddress: string, uniTokenAddress: string) {\n  const response = await window.fetch(\"https://api.thegraph.com/subgraphs/name/uniswap/uniswap-v2\", {\n    method: \"POST\",\n    headers: {\n      \"content-type\": \"application/json\"\n    },\n    body: JSON.stringify({\n      query: uniswapQuery(lqtyTokenAddress, uniTokenAddress),\n      variables: null\n    })\n  });\n\n  if (!response.ok) {\n    return Promise.reject(\"Network error connecting to Uniswap subgraph\");\n  }\n\n  const { data, errors }: UniswapResponse = await response.json();\n\n  if (errors) {\n    return Promise.reject(errors);\n  }\n\n  if (\n    typeof data?.token?.derivedETH === \"string\" &&\n    typeof data?.pair?.reserveUSD === \"string\" &&\n    typeof data?.pair?.totalSupply === \"string\" &&\n    typeof data?.bundle?.ethPrice === \"string\"\n  ) {\n    const ethPriceUSD = Decimal.from(data.bundle.ethPrice);\n    const lqtyPriceUSD = Decimal.from(data.token.derivedETH).mul(ethPriceUSD);\n    const uniLpPriceUSD = Decimal.from(data.pair.reserveUSD).div(\n      Decimal.from(data.pair.totalSupply)\n    );\n\n    return { lqtyPriceUSD, uniLpPriceUSD };\n  }\n\n  return Promise.reject(\"Uniswap doesn't have the required data to calculate yield\");\n}\n"]},"metadata":{},"sourceType":"module"}